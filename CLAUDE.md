# CLAUDE.md - AI Assistant Guide for graniteR

This document provides comprehensive guidance for AI assistants working on the graniteR codebase. It covers architecture, conventions, workflows, and best practices.

## Package Overview

**graniteR** is an R package providing a pipe-friendly interface to IBM's Granite embedding models and other Hugging Face transformer encoder models. The package bridges R and Python using `reticulate`, enabling text embeddings, classification, and fine-tuning workflows with tidyverse conventions.

### Key Features
- **Transfer learning**: Frozen pretrained models with trainable classification heads
- **Local execution**: All inference runs on-device for privacy
- **AutoML**: State-of-the-art meta-learning and CASH-based model selection
- **Multi-class support**: Binary and n-class classification
- **GPU acceleration**: Automatic CUDA detection with CPU fallback
- **Fast setup**: UV package manager for Python dependencies (1-2 min vs 10-20 min)

### Architecture
```
R Layer (User Interface)
├── Tidyverse-style functions (embed, classifier, train, predict)
├── S3 methods for extensibility
└── Column argument handling with tidy evaluation

Python Layer (via reticulate)
├── transformers: Model loading and tokenization
├── torch: Neural network operations
└── datasets: Data handling

Package Organization
├── R/: R source code
├── inst/python/: Python helper scripts
├── tests/testthat/: Unit tests
├── vignettes/: Long-form documentation
└── man/: Auto-generated documentation (never edit directly)
```

## Directory Structure

```
graniteR/
├── R/                          # R source code
│   ├── zzz.R                   # Package initialization (.onLoad, .onAttach)
│   ├── utils.R                 # Helper functions (check_model, to_device, granite_check_system)
│   ├── model.R                 # Model creation (granite_model, granite_tokenizer)
│   ├── embed.R                 # Embedding functions
│   ├── classifier.R            # Standard classification
│   ├── moe_classifier.R        # Mixture of Experts classifier
│   ├── auto_classify.R         # AutoML with meta-learning and CASH
│   ├── ensemble.R              # Ensemble methods
│   ├── meta_features.R         # Dataset meta-feature extraction
│   ├── data.R                  # Data documentation
│   ├── save_load_s3.R          # Model persistence
│   └── graniteR-package.R      # Package documentation
│
├── inst/                       # Installed files
│   ├── python/                 # Python helper scripts
│   │   ├── requirements.txt    # Python dependencies
│   │   ├── granite_utils.py    # Python utilities
│   │   └── moe_classifier.py   # MoE implementation
│   ├── bash/                   # Shell scripts
│   └── extdata/                # External data files
│
├── tests/testthat/             # Unit tests
│   ├── setup.R                 # Test environment setup (Python config)
│   ├── test-*.R                # Test files (one per R source file)
│   └── _snaps/                 # Snapshot tests
│
├── vignettes/                  # Long-form documentation
│   ├── getting-started.Rmd
│   ├── automl-strategies.Rmd
│   ├── mixture-of-experts.Rmd
│   └── [various use cases]
│
├── examples/                   # Standalone examples
│   ├── basic_example.R
│   └── multiclass_classification.R
│
├── data/                       # Package datasets (binary .rda files)
├── data-raw/                   # Scripts to generate package data
├── man/                        # Auto-generated documentation (DO NOT EDIT)
│
├── .github/                    # GitHub configuration
│   ├── workflows/              # CI/CD configuration
│   │   └── R-CMD-check.yaml    # R CMD check workflow
│   ├── CONTRIBUTING.md         # Contribution guidelines
│   ├── DEVELOPMENT.md          # Development workflow
│   ├── SETUP.md                # Setup instructions
│   ├── AUTOML_IMPLEMENTATION.md # AutoML design docs
│   └── AUTOGLUON_COMPARISON.md # Comparison with AutoGluon
│
├── DESCRIPTION                 # Package metadata
├── NAMESPACE                   # Exported functions (auto-generated by roxygen2)
├── NEWS.md                     # Changelog
├── README.md                   # Quick start guide
├── CLAUDE.md                   # AI assistant guide
├── LICENSE.md                  # MIT license
├── pyproject.toml              # Python dependencies (UV format)
└── _pkgdown.yml                # Website configuration
```

## Code Style and Conventions

### R Code Style
- **Pipe operator**: Use native R pipe `|>` (requires R >= 4.1.0), NOT magrittr `%>%`
- **Style guide**: Follow tidyverse style guide
- **Function design**: All exported functions should be pipe-friendly
- **Column arguments**: Use tidy evaluation with `rlang::enquo()` for column arguments
- **Function focus**: Keep functions focused and composable
- **Line length**: Keep lines under 80-100 characters where practical
- **Naming**: Use snake_case for functions and variables

### Documentation Requirements
- **All exported functions** MUST have roxygen2 documentation with:
  - `@title` and description
  - `@param` for each parameter
  - `@return` describing return value
  - `@details` for complex behavior
  - `@export` for exported functions
  - `@examples` (wrapped in `\dontrun{}` if requiring Python)
  - `@examplesIf` for conditional examples (e.g., `@examplesIf requireNamespace("transformers")`)
  - `@seealso` for related functions
- Update `NEWS.md` when adding features or fixing bugs
- Keep `README.md` concise and focused on quick start
- Update vignettes for major features

### Tidy Evaluation Pattern
```r
# Standard pattern for column arguments
my_function <- function(data, text_col, label_col) {
  text_col <- rlang::enquo(text_col)
  label_col <- rlang::enquo(label_col)

  texts <- dplyr::pull(data, !!text_col)
  labels <- dplyr::pull(data, !!label_col)

  # ... rest of function
}
```

### S3 Method Pattern
```r
# Generic function
train <- function(object, ...) {
  UseMethod("train")
}

# Method for specific class
#' @export
train.classifier <- function(object, data, text_col, label_col, epochs = 3, ...) {
  # Implementation
}
```

## Python-R Integration via reticulate

### Package Initialization (R/zzz.R)
```r
# Global Python module references
transformers <- NULL
torch <- NULL

.onLoad <- function(libname, pkgname) {
  # Disable PyTorch JIT to avoid python3-dev dependency
  Sys.setenv(
    PYTORCH_JIT = "0",
    PYTORCH_JIT_USE_NNC_NOT_NVFUSER = "0",
    TORCHDYNAMO_DISABLE = "1"
  )

  # Initialize Python modules
  if (reticulate::py_available(initialize = TRUE)) {
    tryCatch({
      transformers <<- reticulate::import("transformers", delay_load = FALSE)
      torch <<- reticulate::import("torch", delay_load = FALSE)
    }, error = function(e) {
      # Silently fail - message shown in .onAttach
    })
  }
}
```

### Key reticulate Patterns

#### Accessing Python Modules
```r
# Use package-level globals initialized in .onLoad
model <- transformers$AutoModel$from_pretrained(model_name)

# For one-off imports
datasets <- reticulate::import("datasets")
```

#### Python Object Handling
```r
# Python objects are R6 reference objects
# Access attributes with $
output <- model$forward(input_ids)

# Call methods with $
model$eval()  # Sets model to evaluation mode

# Convert between R and Python
r_vector <- c(1, 2, 3)
py_list <- reticulate::r_to_py(r_vector)
back_to_r <- reticulate::py_to_r(py_list)
```

#### Device Management
```r
# Check CUDA availability
has_cuda <- torch$cuda$is_available()

# Move tensors to device
if (device == "cuda") {
  cuda_device <- torch$device("cuda")
  tensor <- tensor$to(cuda_device)
}
```

### Python Environment Setup

#### For Users
```r
# Quick setup using UV (recommended)
library(graniteR)
install_pyenv()  # Installs to .venv/ in 1-2 minutes
```

#### For Developers
```bash
# Clone and setup
git clone https://github.com/skandermulder/graniteR.git
cd graniteR
./setup_python.sh  # Installs UV if needed, creates .venv

# In R session
Sys.setenv(RETICULATE_PYTHON = ".venv/bin/python")
devtools::load_all()
```

#### Environment Priority (tests/testthat/setup.R)
1. `RETICULATE_PYTHON` environment variable (highest priority)
2. `.venv/` directory in package root
3. System Python (`python3` or `python`)

## Testing Patterns

### Test File Organization
- One test file per R source file: `test-classifier.R` tests `R/classifier.R`
- Setup file: `tests/testthat/setup.R` configures Python environment for all tests
- Test files prefixed with `test-`
- Use descriptive test names with `test_that()`

### Python Dependency Handling
```r
# Skip tests if Python or modules unavailable
test_that("classifier creates model", {
  skip_if_not(reticulate::py_available(initialize = TRUE))
  skip_if_not(reticulate::py_module_available("transformers"))

  clf <- classifier(num_labels = 2)
  expect_s3_class(clf, "classifier")
})
```

### Test Best Practices
- **Skip appropriately**: Tests requiring Python should skip if unavailable
- **Use small examples**: Tests should be fast (use small datasets, few epochs)
- **Test both success and failure**: Include error handling tests
- **Avoid side effects**: Tests should not modify global state
- **Use snapshots**: For complex output, use `expect_snapshot()`

### Running Tests
```r
# All tests
devtools::test()

# Specific file
devtools::test_active_file()

# With coverage
covr::package_coverage()
```

## Development Workflow

### 1. Setup Development Environment
```r
# Install dependencies
install.packages(c("devtools", "roxygen2", "testthat", "pkgdown"))
devtools::install_deps()

# Install Python dependencies
library(graniteR)
install_pyenv()
```

### 2. Make Changes
```r
# Load package for interactive development
devtools::load_all()

# After editing R files, reload
devtools::load_all()
```

### 3. Document Changes
```r
# Generate documentation from roxygen2 comments
devtools::document()

# Update NEWS.md manually with changes
```

### 4. Test Changes
```r
# Run tests
devtools::test()

# Run R CMD check (full package check)
devtools::check()
```

### 5. Build and Preview
```r
# Build package website
pkgdown::build_site()

# Build vignettes
devtools::build_vignettes()
```

## Common Tasks and Patterns

### Adding a New Function

1. **Write the function** in appropriate R file (or create new file)
```r
#' Function title
#'
#' Detailed description.
#'
#' @param data Input data frame
#' @param text_col Column containing text (unquoted)
#' @return Description of return value
#' @export
#' @examples
#' \dontrun{
#' result <- my_function(data, text)
#' }
my_function <- function(data, text_col) {
  text_col <- rlang::enquo(text_col)
  # Implementation
}
```

2. **Add roxygen2 documentation** (see above)

3. **Export the function** with `@export` tag

4. **Add tests** in `tests/testthat/test-<file>.R`
```r
test_that("my_function works correctly", {
  skip_if_not(reticulate::py_available(initialize = TRUE))

  result <- my_function(test_data, text)
  expect_true(!is.null(result))
})
```

5. **Update documentation**
```r
devtools::document()  # Generates man/*.Rd files
```

6. **Update NEWS.md**
```markdown
# graniteR 0.1.1 (development)

## New Features
- Added `my_function()` for doing X
```

7. **Run checks**
```r
devtools::check()
```

### Modifying Existing Functions

1. **Update the function** in `R/<file>.R`
2. **Update roxygen2 docs** if signature or behavior changed
3. **Update or add tests**
4. **Run tests** to ensure nothing broke: `devtools::test()`
5. **Update NEWS.md** with changes
6. **Run check**: `devtools::check()`

### Adding Python Functionality

1. **Add Python code** to `inst/python/<name>.py`
2. **Update requirements** if new dependencies needed:
   - `inst/python/requirements.txt`
   - `pyproject.toml`
3. **Import in R** using `reticulate::import()`
```r
my_py_module <- reticulate::import_from_path(
  "my_module",
  system.file("python", package = "graniteR")
)
```
4. **Wrap in R function** with proper error handling
5. **Add tests** with Python dependency checks
6. **Document** the R wrapper function

### Adding a New Vignette

1. **Create file** in `vignettes/my-topic.Rmd`
```yaml
---
title: "My Topic"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{My Topic}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```

2. **Write content** with code examples

3. **Build vignette** to test
```r
devtools::build_vignettes()
```

4. **Add to pkgdown** in `_pkgdown.yml` if needed

5. **Reference in README** if it's a major topic

## Key Design Patterns

### 1. Transfer Learning Architecture
- **Frozen backbone**: By default, pretrained model weights are frozen
- **Trainable head**: Only classification head is trained
- **Benefits**: Faster training, lower memory, better generalization on small datasets
- **Optional fine-tuning**: Set `freeze_backbone = FALSE` for full model training

### 2. AutoML Implementation (auto_classify.R)
The package implements state-of-the-art AutoML using:

#### Meta-Learning
- Extract dataset meta-features (size, entropy, complexity, vocabulary)
- Predict model performance without training
- Rank candidates by predicted performance

#### CASH (Combined Algorithm Selection and Hyperparameters)
- Joint optimization of model architecture AND hyperparameters
- Search space includes:
  - Model types: frozen, fine-tuned, MoE
  - Hyperparameters: learning rates, epochs, num_experts
- Time budget management with early stopping

#### Ensemble Building
- Select diverse high-performing candidates
- Weight by cross-validation performance
- Typically 1-3% accuracy improvement

### 3. Mixture of Experts (MoE)
- Multiple expert networks specialized for different inputs
- Gating network learns to route examples to experts
- Implemented in `R/moe_classifier.R` and `inst/python/moe_classifier.py`
- Benefits: Better handling of complex, multi-modal data

### 4. S3 Object System
Classes used:
- `classifier`: Standard classifier with model and tokenizer
- `moe_classifier`: Mixture of Experts classifier
- `ensemble`: Ensemble of multiple models
- `trained_classifier`: Classifier after training (inherits from `classifier`)

Generic functions with methods:
- `train()`: Train a classifier
- `predict()`: Make predictions
- `print()`: Print object summary
- `save_model()`, `load_model()`: Persistence (S3-compatible)

## Important Gotchas and Best Practices

### 1. Python Environment Issues
**Problem**: Python modules not found after installation
**Solution**:
```r
# Check Python path
Sys.getenv("RETICULATE_PYTHON")

# Set explicitly if needed
Sys.setenv(RETICULATE_PYTHON = "/path/to/.venv/bin/python")

# Restart R session after setting
```

**Best Practice**: Set `RETICULATE_PYTHON` in `.Rprofile` for persistence

### 2. Device Management
**Problem**: CUDA errors or unexpected CPU usage
**Solution**:
```r
# Check CUDA availability
granite_check_system()

# Explicitly set device
clf <- classifier(num_labels = 2, device = "cpu")  # Force CPU
clf <- classifier(num_labels = 2, device = "cuda") # Force CUDA

# Set CUDA device
Sys.setenv(CUDA_VISIBLE_DEVICES = "0")  # Use GPU 0
Sys.setenv(CUDA_VISIBLE_DEVICES = "")   # Force CPU
```

**Best Practice**: Let package auto-detect device unless specific reason to override

### 3. Memory Management
**Problem**: Out of memory errors during training
**Solutions**:
- Use frozen backbone (default) instead of full fine-tuning
- Reduce batch size (not directly exposed, but training uses small batches)
- Use CPU instead of GPU for large models
- Clear Python memory between experiments: `reticulate::py_run_string("import gc; gc.collect()")`

### 4. Documentation Generation
**Problem**: `devtools::document()` fails or produces warnings
**Common Issues**:
- Missing `@param` tags for all parameters
- Missing `@return` tag
- Invalid roxygen2 syntax
- Line breaks in middle of tags

**Solution**: Check roxygen2 syntax carefully, ensure all parameters documented

### 5. Testing with Python Dependencies
**Best Practice**: Always skip tests that require Python/transformers
```r
test_that("function works", {
  skip_if_not(reticulate::py_available(initialize = TRUE))
  skip_if_not(reticulate::py_module_available("transformers"))

  # Test code here
})
```

### 6. Package Check Issues
**Problem**: `devtools::check()` fails with errors or notes

**Common Issues**:
- Undocumented exports
- Examples that fail (wrap in `\dontrun{}` if Python required)
- Missing imports in `NAMESPACE` (handled by roxygen2)
- Non-ASCII characters in documentation
- Files in `.Rbuildignore` that shouldn't be ignored

**Solution**: Read check output carefully, address each NOTE, WARNING, ERROR

### 7. Tidy Evaluation in Functions
**Problem**: Column arguments not working in custom functions
**Pattern**: Always use `enquo()` and `!!` pattern
```r
my_function <- function(data, col) {
  col <- rlang::enquo(col)
  values <- dplyr::pull(data, !!col)
  # Use values...
}
```

### 8. S3 Method Dispatch
**Problem**: Generic function not finding method
**Solution**: Ensure method is exported with `@export`
```r
#' @export
train.classifier <- function(object, ...) {
  # Implementation
}
```

### 9. Python Object Lifecycle
**Issue**: Python objects (models, tokenizers) are R6 reference objects
**Implications**:
- Pass by reference, not by value
- Modifications affect original object
- Cannot serialize with `saveRDS()` directly (use custom save/load functions)

**Best Practice**: Use provided `save_model()` and `load_model()` functions for persistence

### 10. Vignette Building
**Problem**: Vignettes fail to build or have errors
**Common Issues**:
- Python dependencies not available in build environment
- Long-running code (use `eval=FALSE` for slow examples)
- Missing suggested packages

**Solution**:
- Use `eval=FALSE` for Python-dependent chunks
- Keep examples fast and reproducible
- Declare dependencies in `Suggests` field of DESCRIPTION

## Git Workflow for AI Assistants

### Branch Management
- **Main branch**: `main` (protected, requires PR for changes)
- **Development branches**: Create branches with prefix `claude/` for AI work
- **Naming**: Use descriptive names: `claude/feature-name` or `claude/fix-issue-123`

### Commit Messages
- **Format**: Follow conventional commits style
  - `feat:` for new features
  - `fix:` for bug fixes
  - `docs:` for documentation
  - `test:` for test changes
  - `refactor:` for refactoring
  - `chore:` for maintenance tasks
- **Be descriptive**: Explain *why*, not just *what*
- **Reference issues**: Include issue numbers when applicable

Example:
```
feat: add ensemble method for classifier

Implements weighted ensemble combining multiple trained models
for improved prediction accuracy. Includes automatic weight
optimization based on validation performance.

Closes #42
```

### Pull Request Process
1. Create branch from `main`
2. Make changes and commit
3. Run `devtools::check()` and ensure it passes
4. Update `NEWS.md` with changes
5. Push branch: `git push -u origin <branch-name>`
6. Create PR with clear description of changes
7. Ensure CI checks pass

## CI/CD Configuration

### GitHub Actions (`.github/workflows/R-CMD-check.yaml`)
- Runs on: Ubuntu (latest), R (release and devel)
- Steps:
  1. Checkout code
  2. Setup R and dependencies
  3. Setup Python and install transformers/torch
  4. Run `R CMD check`
- Triggered on: Push/PR to main/master branches

**Note**: CI installs Python dependencies with pip (not UV) for compatibility

## Package Website (pkgdown)

### Configuration (`_pkgdown.yml`)
- Defines structure of package website
- Groups functions by category
- Links to vignettes

### Building Website
```r
# Build full site
pkgdown::build_site()

# Build specific components
pkgdown::build_reference()  # Function documentation
pkgdown::build_articles()   # Vignettes
pkgdown::build_home()       # Home page from README
```

### Deployment
- Automatic deployment via GitHub Actions (if configured)
- Manual: `pkgdown::deploy_to_branch()`

## Additional Resources

### Internal Documentation
- `.github/DEVELOPMENT.md`: Development workflow details
- `.github/CONTRIBUTING.md`: Contribution guidelines
- `.github/SETUP.md`: Installation and setup instructions
- `.github/AUTOML_IMPLEMENTATION.md`: AutoML architecture deep dive
- `.github/AUTOGLUON_COMPARISON.md`: Comparison with AutoGluon

### External Resources
- [R Packages Book](https://r-pkgs.org/): Comprehensive R package development guide
- [Advanced R](https://adv-r.hadley.nz/): Deep dive into R programming
- [reticulate documentation](https://rstudio.github.io/reticulate/): Python integration
- [tidyverse style guide](https://style.tidyverse.org/): Code style conventions
- [roxygen2 documentation](https://roxygen2.r-lib.org/): Documentation generation
- [testthat documentation](https://testthat.r-lib.org/): Testing framework

### Key Package Dependencies
- **reticulate** (>= 1.41): R-Python interface
- **dplyr** (>= 1.0.0): Data manipulation
- **tibble** (>= 3.0.0): Modern data frames
- **rlang** (>= 1.0.0): Tidy evaluation
- **cli** (>= 3.0.0): User-facing messages
- **processx**: Process management (for install_pyenv)

### Python Dependencies
- **transformers** (>= 4.35.0): Hugging Face models
- **torch** (>= 2.0.0): PyTorch deep learning
- **datasets** (>= 2.14.0): Dataset handling
- **numpy** (>= 1.24.0): Numerical operations

## Quick Reference: Common Commands

```r
# Development
devtools::load_all()              # Load package for development
devtools::document()              # Generate documentation
devtools::test()                  # Run tests
devtools::check()                 # Full package check
devtools::build()                 # Build package tarball
devtools::install()               # Install package locally

# Documentation
?function_name                    # View function help
vignette("topic")                 # View vignette
pkgdown::build_site()             # Build website

# Testing
devtools::test_file("path/to/test-file.R")  # Test specific file
devtools::test_active_file()      # Test currently open file
testthat::auto_test()             # Continuous testing

# Python Environment
library(graniteR)
install_pyenv()                   # Setup Python environment
granite_check_system()            # Check system configuration
Sys.getenv("RETICULATE_PYTHON")   # Check Python path

# Git
git status                        # Check status
git add .                         # Stage all changes
git commit -m "message"           # Commit with message
git push -u origin branch-name    # Push branch
```

## Version History

See `NEWS.md` for detailed changelog.

**Current Version**: 0.1.0 (Initial release)

## License

MIT © 2024 Skander Tahar Mulder

---

**Document Version**: 1.0.0
**Last Updated**: 2025-11-17
**Maintainer**: Auto-generated for AI assistants working on graniteR
